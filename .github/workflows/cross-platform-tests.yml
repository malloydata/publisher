name: Cross Platform Tests

on:
  workflow_call:

jobs:
  cross_platform_test:
    name: >-
      Platform: (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "true"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.23

      - name: Install dependencies (Unix)
        if: matrix.os != 'windows-latest'
        run: bun install --frozen-lockfile
        shell: bash

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: bun install --frozen-lockfile --linker=isolated
        shell: pwsh
        env:
          BUN_CONFIG_SKIP_POSTINSTALL_SCRIPTS: "1"

      - name: Generate API types
        run: bun run generate-api-types
        shell: bash

      - name: Build (Unix)
        if: matrix.os != 'windows-latest'
        run: bun run build
        shell: bash

      - name: Build (Windows)
        if: matrix.os == 'windows-latest'
        run: bun run build
        shell: pwsh
        env:
          BUN_CONFIG_SKIP_POSTINSTALL_SCRIPTS: "1"

      - name: Run tests
        run: bun run test
        shell: bash
